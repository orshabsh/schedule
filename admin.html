
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Редактор расписания</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 40px; }
    h1 { text-align: center; color: #333; }
    select, input, button { padding: 5px; font-size: 16px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #e0e0e0; }
    .container { max-width: 1000px; margin: auto; }
    .controls { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Редактор расписания</h1>
    <div class="controls">
      <div>
        <label for="class-select">Класс:</label>
        <select id="class-select"></select>
        <button onclick="addClass()">Добавить класс</button>
        <button onclick="removeClass()">Удалить класс</button>
      </div>
      <div>
        <label for="day-select">День недели:</label>
        <select id="day-select"></select>
        <button onclick="saveToGitHub()">Сохранить на GitHub</button>
      </div>
    </div>
    <div id="schedule-container"></div>
  </div>

  <script>
    const password = "admin1977";
    const defaultClasses = {classes};
    const days = {days};
    const lessonTimes = {lesson_times};

    let scheduleData = {};
    let classList = [];
    let adminPassword = password;

    function promptPassword() {
      const input = prompt("Введите пароль администратора:");
      if (input !== password) {
        document.body.innerHTML = "<h2 style='text-align:center;color:red;'>Доступ запрещён</h2>";
      }
    }

    function saveToGitHub() {
      const payload = {
        admin_password: adminPassword,
        classes: classList,
        days: days,
        schedule: scheduleData
      };
      const jsonData = JSON.stringify(payload, null, 2);
      const encodedContent = btoa(unescape(encodeURIComponent(jsonData)));
      const token = "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";  // ← ВСТАВЬТЕ СЮДА ВАШ ТОКЕН 

      fetch('https://api.github.com/repos/orshabsh/schedule/contents/schedule.json', {
        method: "PUT",
        headers: {
          "Authorization": "token " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Обновление расписания",
          content: encodedContent,
          sha: window.currentSha || undefined
        })
      })
      .then(res => res.json())
      .then(response => {
        if (response.content && response.content.sha) {
          window.currentSha = response.content.sha;
          alert("Расписание успешно сохранено на GitHub.");
        } else {
          console.error(response);
          alert("Ошибка при сохранении. Подробности в консоли.");
        }
      });
    }

    function loadSchedule() {
      fetch("https://raw.githubusercontent.com/orshabsh/schedule/main/schedule.json")
        .then(res => res.json())
        .then(data => {
          scheduleData = data.schedule;
          classList = data.classes;
          adminPassword = data.admin_password;
          populateSelectors();
          updateSchedule();
        });
    }

    function populateSelectors() {
      const clsSelect = document.getElementById("class-select");
      const daySelect = document.getElementById("day-select");
      clsSelect.innerHTML = "";
      daySelect.innerHTML = "";

      for (let c of classList) {
        const opt = document.createElement("option");
        opt.value = opt.text = c;
        clsSelect.appendChild(opt);
      }
      for (let d of days) {
        const opt = document.createElement("option");
        opt.value = opt.text = d;
        daySelect.appendChild(opt);
      }
    }

    function updateSchedule() {
      const cls = document.getElementById("class-select").value;
      const day = document.getElementById("day-select").value;
      const lessons = scheduleData[cls][day];
      let html = "<table><tr><th>#</th><th>Время</th><th>Предмет</th><th>Кабинет</th></tr>";
      for (let i = 0; i < 8; i++) {
        const [subject, room] = lessons[i];
        html += `<tr>
          <td>${i}</td>
          <td>${lessonTimes[i]}</td>
          <td><input type='text' value='${subject}' onchange='editCell(${i},0,this.value)'/></td>
          <td><input type='text' value='${room}' onchange='editCell(${i},1,this.value)'/></td>
        </tr>`;
      }
      html += "</table>";
      document.getElementById("schedule-container").innerHTML = html;
    }

    function editCell(row, col, value) {
      const cls = document.getElementById("class-select").value;
      const day = document.getElementById("day-select").value;
      scheduleData[cls][day][row][col] = value;
    }

    function addClass() {
      const newClass = prompt("Введите название нового класса (например, 7В):");
      if (!newClass || classList.includes(newClass)) return;
      classList.push(newClass);
      scheduleData[newClass] = {};
      for (let d of days) {
        scheduleData[newClass][d] = Array(8).fill(["", ""]);
      }
      populateSelectors();
      updateSchedule();
    }

    function removeClass() {
      const cls = document.getElementById("class-select").value;
      if (!confirm(`Удалить класс ${cls}?`)) return;
      classList = classList.filter(c => c !== cls);
      delete scheduleData[cls];
      populateSelectors();
      updateSchedule();
    }

    window.onload = function() {
      promptPassword();
      loadSchedule();
      document.getElementById("class-select").onchange = updateSchedule;
      document.getElementById("day-select").onchange = updateSchedule;
    }
  </script>
</body>
</html>
